# 漸進式遷移指南

## 策略：新舊端點共存

不直接替換現有端點，而是在新的路由前綴下建立重構版本，逐步遷移。

## 遷移方案 A：新路由前綴（推薦）

### 1. 創建新的 API 版本
```
/api/v1/     → 現有端點（保持不變）
/api/v2/     → 新架構端點（使用 Service 層）
```

### 2. 前端逐步遷移
- 先測試 v2 端點功能
- 前端逐個功能切換到 v2
- 確認穩定後移除 v1

**優勢**：
- ✅ 零風險（現有功能不受影響）
- ✅ 可以並行測試
- ✅ 隨時回滾
- ✅ 逐步遷移

---

## 遷移方案 B：特性開關（Feature Flag）

### 1. 環境變數控制
```python
USE_NEW_ARCHITECTURE = os.getenv("USE_NEW_ARCHITECTURE", "false") == "true"

if USE_NEW_ARCHITECTURE:
    from app.api.v1.adoptions_refactored import router
else:
    from app.api.v1.adoptions import router
```

### 2. 分階段啟用
- 開發環境：啟用新架構
- 測試環境：測試新舊對比
- 生產環境：穩定後切換

**優勢**：
- ✅ 同一路由路徑
- ✅ 可以快速切換
- ✅ 便於 A/B 測試

---

## 遷移方案 C：影子模式（Shadow Mode）

### 1. 並行執行
- 主請求使用舊端點
- 背景執行新端點
- 記錄結果差異

### 2. 驗證一致性
- 比較回應格式
- 比較效能指標
- 確認無差異後切換

**優勢**：
- ✅ 完整驗證
- ✅ 發現潛在問題
- ✅ 效能對比

---

## 推薦實施步驟

### Phase 5.1：建立 v2 API（本週）

1. 創建 `/api/v2/` 路由
2. 註冊重構後的端點
3. 配置 CORS 和中介軟體
4. 撰寫 API 文件

### Phase 5.2：功能驗證（下週）

1. 使用 Postman/Thunder Client 測試 v2 端點
2. 比較 v1 和 v2 的回應格式
3. 效能測試（回應時間、資料庫查詢數）
4. 錯誤處理測試

### Phase 5.3：前端整合（第三週）

1. 前端建立 API 配置切換
2. 逐個模組切換到 v2（從 Pets 開始）
3. E2E 測試
4. 使用者驗收測試

### Phase 5.4：全面遷移（第四週）

1. 所有功能切換到 v2
2. 監控生產環境指標
3. 移除 v1 端點
4. 清理舊代碼

---

## 當前狀態檢查

### ✅ 已完成
- [x] Repository 層（12 個類別）
- [x] Service 層（5 個主要 Service）
- [x] Service Factory（依賴注入）
- [x] 自訂例外（21 個）
- [x] Controller 重構版本（5 個檔案）
- [x] 架構測試（100% 通過）

### ⏳ 待完成
- [ ] 創建 v2 路由模組
- [ ] 註冊 v2 端點到 main.py
- [ ] API 文件更新
- [ ] 整合測試
- [ ] 前端配置更新

---

## 立即可執行的命令

### 1. 創建 v2 API 模組
```bash
cd backend/app/api
mkdir v2
```

### 2. 配置 v2 路由
建立 `app/api/v2/__init__.py` 和 `app/api/v2/router.py`

### 3. 在 main.py 中註冊
```python
from app.api.v2.router import api_router as v2_router
app.include_router(v2_router, prefix="/api/v2")
```

### 4. 測試 v2 端點
```bash
curl http://localhost:8000/api/v2/pets
curl http://localhost:8000/api/v2/adoptions
```

---

## 風險評估

| 風險 | 可能性 | 影響 | 緩解措施 |
|------|--------|------|----------|
| API 格式不相容 | 中 | 高 | 建立回應格式適配器 |
| 效能下降 | 低 | 中 | 效能測試 + 快取優化 |
| 遺漏功能 | 中 | 中 | 完整的功能對照表 |
| 資料庫查詢問題 | 低 | 高 | 整合測試 + N+1 檢測 |

---

## 效能指標目標

| 指標 | v1 (現狀) | v2 (目標) | 改善 |
|------|-----------|-----------|------|
| 平均回應時間 | 150ms | <200ms | 持平 |
| 資料庫查詢數 | 5-10 | 2-5 | -50% |
| 記憶體使用 | - | - | 持平 |
| 代碼覆蓋率 | 30% | 70% | +40% |

---

## 回滾計畫

如果遇到問題：

1. **立即回滾**：
   ```bash
   # 在 main.py 中註解掉 v2 路由
   # app.include_router(v2_router, prefix="/api/v2")
   ```

2. **資料修復**：
   - 檢查資料庫是否有異常變更
   - 恢復到最近的備份

3. **通知團隊**：
   - 記錄問題和錯誤日誌
   - 更新遷移文件

---

## 下一步建議

**建議採用方案 A（新路由前綴）**，原因：
1. 最安全（現有功能零影響）
2. 易於測試和驗證
3. 可以並行開發
4. 前端改動最小

**立即行動**：
1. 創建 `app/api/v2/` 目錄結構
2. 複製 `*_refactored.py` 檔案到 v2
3. 建立 v2 路由註冊
4. 啟動測試

需要我繼續執行 v2 API 的建立嗎？
